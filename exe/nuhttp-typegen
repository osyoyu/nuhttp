#!/usr/bin/env ruby
# frozen_string_literal: true

require 'stringio'
require 'prism'

class RouteCollector < Prism::Visitor
  attr_reader :routes

  def initialize
    super()
    @routes = {
      get: [],
      post: [],
    }
  end

  def visit_call_node(node)
    if node.name == :app
      block = node.block
      self.visit(block) if block
    end

    if [:get, :post].include?(node.name)
      http_method = node.name
      path = node.arguments.arguments.first
      return nil if !path.is_a?(Prism::StringNode)

      path_pattern = path.unescaped
      # Check for dups
      return if @routes[http_method].any? {|r| r[:path_pattern] == path_pattern }

      param_names = extract_param_names(path.unescaped)
      rbs_interface_name = if param_names.size == 0
        "params_none"
      else
        "params_" + path_pattern.gsub(/[:\/]/, '_').gsub(/[^a-zA-Z0-9_]/, '')
      end

      @routes[http_method] << {
        path_pattern:, param_names:, rbs_interface_name:,
      }

      nil
    end
  end

  def extract_param_names(path_pattern)
    param_names = []
    path_pattern.scan(/:([a-zA-Z_][a-zA-Z0-9_]*)/) do |match|
      param_names << match.first
    end
    param_names
  end
end

class RbsEmitter
  def initialize(routes, io = $stdout)
    @routes = routes
    @io = io
  end

  def emit
    @io.puts <<-__EOS__
# Type signature generated by nuhttp-typegen. DO NOT EDIT.

module NuHttp
  class Builder
    type params_none = Hash[Symbol, String]
__EOS__

    # Interfaces for params
    (@routes[:get] + @routes[:post]).each do |route|
      next if route[:param_names].empty?
      @io.puts <<-__EOS__
    type #{route[:rbs_interface_name]} = Hash[(#{route[:param_names].map {|n| ":#{n}" }.join(" | ")}), String]
__EOS__
    end
    @io.puts ""

    # GET
    types = @routes[:get].map do |route|
      "(\"#{route[:path_pattern]}\") { (Context[#{route[:rbs_interface_name]}]) -> void } -> untyped"
    end
    types << "(untyped path) { (Context[params_none]) -> void } -> untyped"
    @io.print <<-__EOS__
    def get: #{types.join("\n           | ")}
__EOS__
    @io.puts ""

    # POST
    types = @routes[:post].map do |route|
      "(\"#{route[:path_pattern]}\") { (Context[#{route[:rbs_interface_name]}]) -> void } -> untyped"
    end
    types << "(untyped path) { (Context[params_none]) -> void } -> untyped"
    @io.print <<-__EOS__
    def post: #{types.join("\n            | ")}
__EOS__
    @io.puts ""


    @io.print <<-__EOS__
  end
end
__EOS__
  end
end

paths = Dir.glob("**/*.rb")
visitor = RouteCollector.new
paths.each do |path|
  parsed = Prism.parse(File.read(path))

  visitor.visit(parsed.value)
end
RbsEmitter.new(visitor.routes).emit
